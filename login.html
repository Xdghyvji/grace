<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Grace Academy - Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar and other shared styles */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .btn-loading {
            position: relative;
            pointer-events: none;
            color: transparent !important;
        }
        .btn-loading::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            margin-left: -12px;
            margin-top: -12px;
            width: 24px;
            height: 24px;
            border: 2px solid #fff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="font-sans antialiased text-gray-800 bg-gray-50 flex flex-col min-h-screen">

    <header class="bg-gradient-to-r from-blue-700 to-blue-900 text-white shadow-lg sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center">
                <a href="index.html" class="flex items-center space-x-3">
                    <img src="https://placehold.co/60x60/FFFFFF/3B82F6?text=GA" alt="The Grace Academy Logo" class="h-12 w-auto rounded-full">
                    <span class="text-3xl font-bold tracking-tight">The Grace Academy</span>
                </a>
            </div>
            <div class="hidden lg:flex space-x-8">
                <a href="index.html" class="hover:text-blue-200 transition duration-300 ease-in-out text-lg font-medium">Home</a>
                <a href="index.html#about" class="hover:text-blue-200 transition duration-300 ease-in-out text-lg font-medium">About Us</a>
                <a href="index.html#courses" class="hover:text-blue-200 transition duration-300 ease-in-out text-lg font-medium">Courses</a>
                <a href="blog.html" class="hover:text-blue-200 transition duration-300 ease-in-out text-lg font-medium">Blog</a>
                <a href="index.html#contact" class="hover:text-blue-200 transition duration-300 ease-in-out text-lg font-medium">Contact</a>
            </div>
            <div class="flex items-center space-x-4">
                 <a href="index.html" class="hidden lg:block bg-white text-blue-800 px-6 py-2 rounded-full font-semibold shadow-md hover:bg-blue-100 transition duration-300 ease-in-out transform hover:scale-105">
                    Back to Home
                </a>
                <button id="mobile-menu-button" class="lg:hidden text-white focus:outline-none">
                    <svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
            </div>
        </nav>
        <div id="mobile-menu" class="hidden lg:hidden bg-blue-800">
             <div class="flex flex-col items-center space-y-4 py-4">
                <a href="index.html" class="block text-white text-lg hover:text-blue-200">Home</a>
                <a href="index.html#about" class="block text-white text-lg hover:text-blue-200">About Us</a>
                <a href="index.html#courses" class="block text-white text-lg hover:text-blue-200">Courses</a>
                <a href="blog.html" class="block text-white text-lg hover:text-blue-200">Blog</a>
                <a href="index.html#contact" class="block text-white text-lg hover:text-blue-200">Contact</a>
            </div>
        </div>
    </header>

    <main class="flex-1 flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8 bg-gradient-to-br from-blue-100 to-white">
        <div class="max-w-md w-full space-y-8 p-10 bg-white rounded-xl shadow-2xl border border-blue-200">
            <div>
                <img class="mx-auto h-20 w-auto" src="https://placehold.co/80x80/3B82F6/FFFFFF?text=GA" alt="The Grace Academy">
                <h2 class="mt-6 text-center text-4xl font-extrabold text-blue-900">
                    Sign in to your account
                </h2>
                <p class="mt-2 text-center text-sm text-gray-600">
                    Access your student, teacher, or admin portal
                </p>
            </div>
            <form class="mt-8 space-y-6" id="loginForm">
                <div class="rounded-md shadow-sm -space-y-px">
                    <div>
                        <label for="email-address" class="sr-only">Email address</label>
                        <input id="email-address" name="email" type="email" autocomplete="email" required class="appearance-none rounded-none relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-lg" placeholder="Email address">
                    </div>
                    <div>
                        <label for="password" class="sr-only">Password</label>
                        <input id="password" name="password" type="password" autocomplete="current-password" required class="appearance-none rounded-none relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-lg" placeholder="Password">
                    </div>
                </div>
                <div>
                    <button type="submit" id="signin-button" class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-lg font-medium rounded-md text-white bg-blue-700 hover:bg-blue-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300 ease-in-out transform hover:scale-105">
                        <span class="absolute left-0 inset-y-0 flex items-center pl-3">
                            <svg class="h-5 w-5 text-blue-300 group-hover:text-blue-100" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" />
                            </svg>
                        </span>
                        Sign in
                    </button>
                </div>
            </form>
            <div id="loginMessage" class="mt-4 text-center text-sm font-medium text-red-600"></div>
        </div>
    </main>

    <footer class="bg-gray-800 text-white py-12">
        <div class="container mx-auto px-6 grid grid-cols-1 md:grid-cols-4 gap-8">
            <div>
                <h3 class="text-2xl font-bold mb-4 text-blue-400">The Grace Academy</h3>
                <p class="text-gray-400 mb-4">
                    Committed to nurturing young minds and empowering them for a brighter future through quality education in Paigah Dera Ghazi Khan.
                </p>
                <div class="flex space-x-4 text-gray-400">
                    <a href="#" class="hover:text-white transition-colors duration-300"><i class="fab fa-facebook-f text-xl"></i></a>
                    <a href="#" class="hover:text-white transition-colors duration-300"><i class="fab fa-twitter text-xl"></i></a>
                    <a href="#" class="hover:text-white transition-colors duration-300"><i class="fab fa-instagram text-xl"></i></a>
                    <a href="#" class="hover:text-white transition-colors duration-300"><i class="fab fa-linkedin-in text-xl"></i></a>
                </div>
            </div>
            <div>
                <h3 class="text-2xl font-bold mb-4 text-blue-400">Quick Links</h3>
                <ul class="space-y-3">
                    <li><a href="index.html" class="text-gray-400 hover:text-white transition-colors duration-300">Home</a></li>
                    <li><a href="index.html#about" class="text-gray-400 hover:text-white transition-colors duration-300">About Us</a></li>
                    <li><a href="index.html#courses" class="text-gray-400 hover:text-white transition-colors duration-300">Our Programs</a></li>
                    <li><a href="blog.html" class="text-gray-400 hover:text-white transition-colors duration-300">Blog</a></li>
                    <li><a href="index.html#contact" class="text-gray-400 hover:text-white transition-colors duration-300">Contact Us</a></li>
                </ul>
            </div>
            <div>
                <h3 class="text-2xl font-bold mb-4 text-blue-400">Student Zone</h3>
                <ul class="space-y-3">
                    <li><a href="login.html" class="text-gray-400 hover:text-white transition-colors duration-300">Student Login</a></li>
                    <li><a href="#" class="text-gray-400 hover:text-white transition-colors duration-300">Admissions</a></li>
                </ul>
            </div>
            <div>
                <h3 class="text-2xl font-bold mb-4 text-blue-400">Reach Us</h3>
                <ul class="space-y-3 text-gray-400">
                    <li><i class="fas fa-map-marker-alt mr-2 text-blue-500"></i>Paigah Dera Ghazi Khan, Pakistan</li>
                    <li><i class="fas fa-phone-alt mr-2 text-blue-500"></i>0336-2268687</li>
                    <li><i class="fas fa-envelope mr-2 text-blue-500"></i>thegraceacademy786@gmail.com</li>
                </ul>
            </div>
        </div>
        <div class="border-t border-gray-700 mt-10 pt-8 text-center text-gray-500 text-sm">
            &copy; <span id="current-year"></span> The Grace Academy. All rights reserved.
        </div>
    </footer>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA65vwfeuvsxnVSmlTof1_khaPmNtiMMv0",
            authDomain: "non-ruled.firebaseapp.com",
            projectId: "non-ruled",
            storageBucket: "non-ruled.firebasestorage.app",
            messagingSenderId: "981177762303",
            appId: "1:981177762303:web:7db5c95c3b264444e267ca",
            measurementId: "G-E3TY5JLVT5"
        };
        
        const loginMessage = document.getElementById('loginMessage');

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const loginForm = document.getElementById('loginForm');
        const signinButton = document.getElementById('signin-button');

        let isRedirecting = false;

        onAuthStateChanged(auth, async (user) => {
            console.log('Auth state changed. User:', user ? user.email : 'No user');
            if (user && !user.isAnonymous) {
                await checkUserRoleAndRedirect(user);
            }
        });

        loginForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            
            const email = document.getElementById('email-address').value;
            const password = document.getElementById('password').value;
            
            loginMessage.textContent = '';
            signinButton.classList.add('btn-loading');
            signinButton.disabled = true;

            try {
                if (auth.currentUser) {
                    await signOut(auth);
                }
                
                await signInWithEmailAndPassword(auth, email, password);

            } catch (error) {
                console.error("Login Failed:", error.code, error.message);
                handleLoginError(error);
                signinButton.classList.remove('btn-loading');
                signinButton.disabled = false;
            } 
        });

        async function checkUserRoleAndRedirect(user) {
            if (isRedirecting) {
                console.log("Redirect already in progress. Aborting duplicate call.");
                return;
            }

            const userId = user.uid;
            const userEmail = user.email;
            const userDocRef = doc(db, "users", userId);
            
            try {
                console.log(`Checking Firestore for user role document: users/${userId}`);
                const userDoc = await getDoc(userDocRef);

                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    const userRole = userData.role;
                    console.log(`User document found. Role: '${userRole}'.`);
                    
                    if (!userRole) {
                        loginMessage.textContent = 'Login failed: Your account has no assigned role.';
                        await signOut(auth);
                        return;
                    }

                    isRedirecting = true; 
                    loginMessage.textContent = 'Login successful! Redirecting...';
                    loginMessage.className = 'mt-4 text-center text-sm font-medium text-green-600';

                    setTimeout(() => {
                        switch (userRole) {
                            case 'admin':
                                window.location.href = 'admin.html';
                                break;
                            case 'teacher':
                                window.location.href = 'teacher.html';
                                break;
                            case 'student':
                                window.location.href = 'student.html';
                                break;
                            default:
                                console.error(`Invalid role found in Firestore: '${userRole}'. Expected 'admin', 'teacher', or 'student'.`);
                                loginMessage.textContent = 'Your assigned role is invalid. Please contact an administrator.';
                                isRedirecting = false; 
                                signOut(auth);
                        }
                    }, 500);

                } else {
                    console.warn(`Login failed for ${userEmail}: User authenticated successfully, but a corresponding user document was not found in the Firestore 'users' collection.`);
                    loginMessage.textContent = 'Authentication successful, but no user profile found in database. Please contact an administrator to set up your role.';
                    await signOut(auth);
                }
            } catch (error) {
                console.error("CRITICAL: Error fetching user role from Firestore:", error);
                loginMessage.textContent = 'A critical error occurred while verifying your user role.';
                isRedirecting = false;
                await signOut(auth);
            }
        }

        function handleLoginError(error) {
            switch (error.code) {
                case 'auth/user-not-found':
                case 'auth/wrong-password':
                case 'auth/invalid-credential':
                    loginMessage.textContent = 'Invalid email or password.';
                    break;
                case 'auth/invalid-email':
                    loginMessage.textContent = 'Please enter a valid email address.';
                    break;
                case 'auth/too-many-requests':
                    loginMessage.textContent = 'Access to this account has been temporarily disabled due to many failed login attempts.';
                    break;
                default:
                    loginMessage.textContent = 'An unexpected error occurred during login.';
            }
        }

        document.getElementById('mobile-menu-button').addEventListener('click', function() {
            document.getElementById('mobile-menu').classList.toggle('hidden');
        });

        document.getElementById('current-year').textContent = new Date().getFullYear();
    </script>
</body>
</html>

