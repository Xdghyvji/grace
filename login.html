<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Grace Academy - Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .btn-loading { position: relative; pointer-events: none; color: transparent !important; }
        .btn-loading::after {
            content: ''; position: absolute; left: 50%; top: 50%; margin-left: -12px; margin-top: -12px;
            width: 24px; height: 24px; border: 2px solid #fff; border-top-color: transparent; border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="font-sans antialiased text-gray-800 bg-gray-50 flex flex-col min-h-screen">

    <header class="bg-gradient-to-r from-blue-700 to-blue-900 text-white shadow-lg sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center">
                <a href="index.html" class="flex items-center space-x-3">
                    <img src="download (2).png" alt="The Grace Academy Logo" class="h-12 w-auto rounded-full">
                    <span class="text-3xl font-bold tracking-tight">The Grace Academy</span>
                </a>
            </div>
            <div class="hidden lg:flex space-x-8">
                <a href="index.html" class="hover:text-blue-200 transition duration-300 ease-in-out text-lg font-medium">Home</a>
                <a href="index.html#about" class="hover:text-blue-200 transition duration-300 ease-in-out text-lg font-medium">About Us</a>
                <a href="index.html#courses" class="hover:text-blue-200 transition duration-300 ease-in-out text-lg font-medium">Courses</a>
                <a href="blog.html" class="hover:text-blue-200 transition duration-300 ease-in-out text-lg font-medium">Blog</a>
            </div>
        </nav>
    </header>

    <main class="flex-1 flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8 bg-gradient-to-br from-blue-100 to-white">
        <div class="max-w-md w-full space-y-8 p-10 bg-white rounded-xl shadow-2xl border border-blue-200">
            <div>
                <img class="mx-auto h-20 w-auto" src="download (2).png" alt="The Grace Academy">
                <h2 class="mt-6 text-center text-4xl font-extrabold text-blue-900">Sign in</h2>
                <p class="mt-2 text-center text-sm text-gray-600">Access your student, teacher, or admin portal</p>
            </div>
            <form class="mt-8 space-y-6" id="loginForm">
                <div class="rounded-md shadow-sm -space-y-px">
                    <div>
                        <label for="email-address" class="sr-only">Email address</label>
                        <input id="email-address" name="email" type="email" autocomplete="email" required 
                            class="appearance-none rounded-none relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-lg" 
                            placeholder="Email address">
                    </div>
                    <div>
                        <label for="password" class="sr-only">Password</label>
                        <input id="password" name="password" type="password" autocomplete="current-password" required 
                            class="appearance-none rounded-none relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-lg" 
                            placeholder="Password">
                    </div>
                </div>
                <div>
                    <button type="submit" id="signin-button" class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-lg font-medium rounded-md text-white bg-blue-700 hover:bg-blue-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300 ease-in-out transform hover:scale-105">
                        <span class="absolute left-0 inset-y-0 flex items-center pl-3">
                            <svg class="h-5 w-5 text-blue-300 group-hover:text-blue-100" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" />
                            </svg>
                        </span>
                        Sign in
                    </button>
                </div>
            </form>
            <div id="loginMessage" class="mt-4 text-center text-sm font-medium text-red-600 min-h-[20px]"></div>
        </div>
    </main>

    <footer class="bg-gray-800 text-white py-12">
        <div class="container mx-auto px-6 text-center text-gray-400">
            <p>&copy; <span id="current-year"></span> The Grace Academy. All rights reserved.</p>
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA65vwfeuvsxnVSmlTof1_khaPmNtiMMv0",
            authDomain: "non-ruled.firebaseapp.com",
            projectId: "non-ruled",
            storageBucket: "non-ruled.firebasestorage.app",
            messagingSenderId: "981177762303",
            appId: "1:981177762303:web:7db5c95c3b264444e267ca",
            measurementId: "G-E3TY5JLVT5"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const loginForm = document.getElementById('loginForm');
        const signinButton = document.getElementById('signin-button');
        const loginMessage = document.getElementById('loginMessage');

        // Admin recovery email - if this email logs in, we force create admin data
        const RECOVERY_ADMIN_EMAIL = "admin@grace.com";

        let isProcessing = false;

        onAuthStateChanged(auth, async (user) => {
            if (user && !isProcessing) {
                // If the page loads and user is already logged in, verify them
                isProcessing = true;
                signinButton.classList.add('btn-loading');
                await checkUserRoleAndRedirect(user);
            }
        });

        loginForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            if (isProcessing) return;

            const email = document.getElementById('email-address').value.trim();
            const password = document.getElementById('password').value;

            loginMessage.textContent = '';
            signinButton.classList.add('btn-loading');
            signinButton.disabled = true;
            isProcessing = true;

            try {
                // Force logout first to clear any stale states
                if (auth.currentUser) await signOut(auth);
                
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                // logic continues in onAuthStateChanged or we can call it here manually
                // onAuthStateChanged will trigger automatically, so we wait.
            } catch (error) {
                console.error("Login Failed:", error);
                handleLoginError(error);
                signinButton.classList.remove('btn-loading');
                signinButton.disabled = false;
                isProcessing = false;
            } 
        });

        async function checkUserRoleAndRedirect(user) {
            loginMessage.textContent = 'Verifying access privileges...';
            loginMessage.className = 'mt-4 text-center text-sm font-medium text-blue-600';

            const userDocRef = doc(db, "users", user.uid);
            
            try {
                let userDoc = await getDoc(userDocRef);

                // --- AUTO-FIX FOR ADMIN ---
                // If specific admin email tries to login but has no database entry, create it.
                if (user.email.toLowerCase() === RECOVERY_ADMIN_EMAIL.toLowerCase()) {
                    if (!userDoc.exists() || userDoc.data().role !== 'admin') {
                        console.log("Recovery Admin detected. Provisioning database...");
                        await setDoc(userDocRef, {
                            role: 'admin',
                            email: user.email,
                            name: 'Administrator',
                            createdAt: serverTimestamp(),
                            profileImageUrl: 'https://placehold.co/40x40/FF0000/FFFFFF?text=A'
                        }, { merge: true });
                        // Refresh doc
                        userDoc = await getDoc(userDocRef);
                    }
                }
                // --------------------------

                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    const userRole = userData.role;

                    loginMessage.textContent = 'Login successful! Redirecting...';
                    loginMessage.className = 'mt-4 text-center text-sm font-medium text-green-600';

                    setTimeout(() => {
                        if (userRole === 'admin') window.location.href = 'admin.html';
                        else if (userRole === 'teacher') window.location.href = 'teacher.html';
                        else if (userRole === 'student') window.location.href = 'student.html';
                        else {
                            throw new Error('Role undefined');
                        }
                    }, 1000);
                } else {
                    // Valid auth, but no DB entry (and not the recovery admin)
                    throw new Error('User profile missing');
                }
            } catch (error) {
                console.error("Role Verification Failed:", error);
                loginMessage.textContent = error.message === 'User profile missing' 
                    ? 'Account exists but has no role assigned. Contact Admin.' 
                    : 'Error verifying user role. Please try again.';
                loginMessage.className = 'mt-4 text-center text-sm font-medium text-red-600';
                
                // Sign out so they don't get stuck in a "logged in but invalid" state
                await signOut(auth);
                signinButton.classList.remove('btn-loading');
                signinButton.disabled = false;
                isProcessing = false;
            }
        }

        function handleLoginError(error) {
            let msg = 'An unexpected error occurred.';
            if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password') {
                msg = 'Invalid email or password.';
            } else if (error.code === 'auth/invalid-email') {
                msg = 'Please enter a valid email address.';
            } else if (error.code === 'auth/too-many-requests') {
                msg = 'Too many failed attempts. Please try again later.';
            } else if (error.code === 'auth/network-request-failed') {
                msg = 'Network error. Please check your connection.';
            }
            loginMessage.textContent = msg;
            loginMessage.className = 'mt-4 text-center text-sm font-medium text-red-600';
        }

        document.getElementById('current-year').textContent = new Date().getFullYear();
    </script>
</body>
</html>
