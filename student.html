<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Portal - The Grace Academy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Glass Effect for Cards */
        .glass-card { background: white; border: 1px solid #e5e7eb; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
    </style>
</head>
<body class="flex h-screen overflow-hidden text-gray-800">

    <!-- Sidebar -->
    <aside class="w-64 bg-blue-900 text-white hidden md:flex flex-col shadow-xl z-20">
        <div class="h-20 flex items-center justify-center border-b border-blue-800 bg-blue-950">
            <div class="flex items-center space-x-2">
                <div class="h-10 w-10 bg-white rounded-full flex items-center justify-center text-blue-900 font-bold text-lg">G</div>
                <span class="text-xl font-bold tracking-wide">Grace Academy</span>
            </div>
        </div>
        
        <nav class="flex-1 py-6 px-3 space-y-2 overflow-y-auto">
            <button onclick="showSection('dashboard')" class="nav-btn active w-full flex items-center space-x-3 px-4 py-3 rounded-lg bg-blue-800 text-white transition" id="nav-dashboard">
                <i class="fas fa-th-large w-5"></i>
                <span class="font-medium">Dashboard</span>
            </button>
            <button onclick="showSection('timetable')" class="nav-btn w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-blue-800 text-blue-100 transition" id="nav-timetable">
                <i class="fas fa-clock w-5"></i>
                <span class="font-medium">My Timetable</span>
            </button>
            <button onclick="showSection('tests')" class="nav-btn w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-blue-800 text-blue-100 transition" id="nav-tests">
                <i class="fas fa-clipboard-list w-5"></i>
                <span class="font-medium">Scheduled Tests</span>
            </button>
            <button onclick="showSection('fees')" class="nav-btn w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-blue-800 text-blue-100 transition" id="nav-fees">
                <i class="fas fa-file-invoice-dollar w-5"></i>
                <span class="font-medium">Fees & Payments</span>
            </button>
            <button onclick="showSection('announcements')" class="nav-btn w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-blue-800 text-blue-100 transition" id="nav-announcements">
                <i class="fas fa-bullhorn w-5"></i>
                <span class="font-medium">Announcements</span>
            </button>
        </nav>

        <div class="p-4 border-t border-blue-800 bg-blue-950">
            <div class="flex items-center space-x-3 mb-4 px-2">
                <div class="h-8 w-8 rounded-full bg-blue-700 flex items-center justify-center text-xs font-bold" id="sidebar-initials">--</div>
                <div class="overflow-hidden">
                    <p id="sidebar-name" class="text-sm font-semibold truncate">Loading...</p>
                    <p id="sidebar-roll" class="text-xs text-blue-300">Student</p>
                </div>
            </div>
            <button onclick="logout()" class="w-full flex items-center justify-center space-x-2 bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg transition text-sm font-medium">
                <i class="fas fa-sign-out-alt"></i><span>Sign Out</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col h-screen overflow-hidden relative">
        
        <!-- Mobile Header -->
        <header class="bg-white shadow-sm z-10 h-16 flex items-center justify-between px-6 md:px-8">
            <div class="flex items-center md:hidden">
                <button class="text-gray-600 focus:outline-none mr-4"><i class="fas fa-bars text-2xl"></i></button>
                <span class="font-bold text-lg text-blue-900">Student Portal</span>
            </div>
            <h2 id="page-title" class="hidden md:block text-2xl font-bold text-gray-800">Dashboard</h2>
            <div class="flex items-center space-x-4">
                <span class="bg-blue-50 text-blue-600 px-3 py-1 rounded-full text-sm font-medium border border-blue-100" id="header-class-info">Loading Class...</span>
            </div>
        </header>

        <!-- Main Scrollable Area -->
        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-50 p-6 relative">
            
            <!-- Loading Overlay -->
            <div id="loading-overlay" class="absolute inset-0 bg-white z-50 flex items-center justify-center">
                <div class="text-center">
                    <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-blue-600 border-solid mx-auto mb-4"></div>
                    <p class="text-gray-600 font-medium">Synchronizing Profile...</p>
                </div>
            </div>

            <!-- SECTION: DASHBOARD -->
            <div id="dashboard" class="content-section fade-in">
                <!-- Stats -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <!-- Fee Status -->
                    <div class="glass-card rounded-xl p-6 border-l-4 border-red-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs text-gray-500 uppercase font-bold tracking-wider">Total Fee Due</p>
                                <h3 id="dash-due" class="text-3xl font-bold text-gray-800 mt-1">PKR 0</h3>
                            </div>
                            <div class="p-3 bg-red-50 text-red-600 rounded-lg"><i class="fas fa-wallet text-xl"></i></div>
                        </div>
                        <button onclick="showSection('fees')" class="text-sm text-red-600 font-medium mt-3 hover:underline flex items-center">
                            Pay Now <i class="fas fa-arrow-right ml-1"></i>
                        </button>
                    </div>

                    <!-- Attendance (Mock) -->
                    <div class="glass-card rounded-xl p-6 border-l-4 border-green-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs text-gray-500 uppercase font-bold tracking-wider">Attendance</p>
                                <h3 id="dash-attendance" class="text-3xl font-bold text-gray-800 mt-1">--%</h3>
                            </div>
                            <div class="p-3 bg-green-50 text-green-600 rounded-lg"><i class="fas fa-user-check text-xl"></i></div>
                        </div>
                        <p class="text-xs text-gray-400 mt-3">Current Academic Session</p>
                    </div>

                    <!-- Next Test -->
                    <div class="glass-card rounded-xl p-6 border-l-4 border-blue-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs text-gray-500 uppercase font-bold tracking-wider">Next Assessment</p>
                                <h3 id="dash-next-test" class="text-xl font-bold text-gray-800 mt-1 truncate w-40">Checking...</h3>
                            </div>
                            <div class="p-3 bg-blue-50 text-blue-600 rounded-lg"><i class="fas fa-flask text-xl"></i></div>
                        </div>
                        <p id="dash-next-test-date" class="text-sm text-blue-600 font-medium mt-3">--</p>
                    </div>
                </div>

                <!-- Recent Announcements Preview -->
                <div class="glass-card rounded-xl overflow-hidden mb-8">
                    <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                        <h3 class="font-bold text-gray-800">Latest Updates</h3>
                        <button onclick="showSection('announcements')" class="text-blue-600 text-sm hover:underline">View All</button>
                    </div>
                    <div id="dash-announcements" class="divide-y divide-gray-100">
                        <div class="p-6 text-center text-gray-400">No new announcements.</div>
                    </div>
                </div>
            </div>

            <!-- SECTION: TIMETABLE -->
            <div id="timetable" class="content-section hidden fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Class Schedule</h2>
                    <button onclick="window.print()" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 transition shadow-sm">
                        <i class="fas fa-print mr-2"></i> Print
                    </button>
                </div>
                <div class="glass-card rounded-xl overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-blue-900 text-white text-sm uppercase">
                                <tr>
                                    <th class="px-6 py-4">Day</th>
                                    <th class="px-6 py-4">Time Slot</th>
                                    <th class="px-6 py-4">Subject</th>
                                    <th class="px-6 py-4">Teacher</th>
                                </tr>
                            </thead>
                            <tbody id="timetable-body" class="text-sm text-gray-700 divide-y divide-gray-100">
                                <tr><td colspan="4" class="p-6 text-center text-gray-500">Loading schedule...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- SECTION: TESTS -->
            <div id="tests" class="content-section hidden fade-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Upcoming Examinations</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6" id="tests-container">
                    <!-- Populated via JS -->
                </div>
            </div>

            <!-- SECTION: FEES -->
            <div id="fees" class="content-section hidden fade-in">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Payment Action -->
                    <div class="lg:col-span-1">
                        <div class="glass-card rounded-xl p-6 mb-6">
                            <h3 class="font-bold text-lg text-gray-800 mb-4">Make a Payment</h3>
                            <div class="bg-blue-50 p-4 rounded-lg border border-blue-100 mb-6">
                                <p class="text-sm text-blue-600 mb-1">Total Outstanding</p>
                                <p class="text-3xl font-bold text-blue-900" id="fee-section-due">PKR 0</p>
                            </div>
                            <button onclick="openModal('modal-pay')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-lg transition transform hover:-translate-y-0.5">
                                <i class="fas fa-upload mr-2"></i> Submit Payment Proof
                            </button>
                            <p class="text-xs text-gray-500 mt-4 text-center">
                                Upload a screenshot of your Easypaisa, JazzCash, or Bank transfer.
                            </p>
                        </div>

                        <div class="glass-card rounded-xl p-6">
                            <h3 class="font-bold text-lg text-gray-800 mb-4">Pending Approvals</h3>
                            <div id="pending-payments-list" class="space-y-3">
                                <!-- JS -->
                            </div>
                        </div>
                    </div>

                    <!-- History -->
                    <div class="lg:col-span-2">
                        <div class="glass-card rounded-xl overflow-hidden">
                            <div class="px-6 py-4 border-b border-gray-100 bg-gray-50">
                                <h3 class="font-bold text-gray-800">Transaction History</h3>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left text-sm">
                                    <thead class="bg-white text-gray-500 border-b border-gray-100">
                                        <tr>
                                            <th class="px-6 py-3">Date</th>
                                            <th class="px-6 py-3">Description</th>
                                            <th class="px-6 py-3">Reference</th>
                                            <th class="px-6 py-3 text-right">Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody id="transactions-body" class="divide-y divide-gray-50 text-gray-700">
                                        <!-- JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECTION: ANNOUNCEMENTS -->
            <div id="announcements" class="content-section hidden fade-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">School Announcements</h2>
                <div id="announcements-container" class="space-y-4">
                    <!-- JS -->
                </div>
            </div>

        </main>
    </div>

    <!-- MODAL: UPLOAD PROOF -->
    <div id="modal-pay" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 overflow-hidden animate-fade-in-up">
            <div class="bg-blue-600 px-6 py-4 flex justify-between items-center">
                <h3 class="font-bold text-white text-lg">Submit Payment Proof</h3>
                <button onclick="closeModal('modal-pay')" class="text-white hover:text-blue-200"><i class="fas fa-times"></i></button>
            </div>
            <form id="form-proof" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Amount Paid (PKR)</label>
                    <input type="number" id="proof-amount" required class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none transition">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Transaction ID / Reference</label>
                    <input type="text" id="proof-ref" placeholder="e.g. TID-123456789" required class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none transition">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Screenshot (Image)</label>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:bg-gray-50 transition cursor-pointer relative">
                        <input type="file" id="proof-file" accept="image/*" required class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                        <div class="text-gray-500 pointer-events-none">
                            <i class="fas fa-cloud-upload-alt text-2xl mb-2"></i>
                            <p class="text-xs">Click to upload image (Max 500KB)</p>
                        </div>
                    </div>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow mt-2 transition transform hover:-translate-y-0.5">
                    Submit for Approval
                </button>
            </form>
        </div>
    </div>

    <script>
        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDrOEtaX7Hhp248bI8oQiMTiGCbK2QdMho",
            authDomain: "sultania-3e5ca.firebaseapp.com",
            projectId: "sultania-3e5ca",
            storageBucket: "sultania-3e5ca.firebasestorage.app",
            messagingSenderId: "429093155759",
            appId: "1:429093155759:web:76224bef015291ba83355a",
            measurementId: "G-KBDE0PLY8R"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = "sultania-academy-v1";
        
        // Helper for strict paths
        function getCollection(name) { return db.collection('artifacts').doc(appId).collection('public').doc('data').collection(name); }

        let currentUser = null;
        let studentProfile = null;
        let classId = null;

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            const session = JSON.parse(localStorage.getItem('grace_user_session'));
            if (!session || !session.isLoggedIn || session.role !== 'student') {
                window.location.href = 'login.html';
                return;
            }

            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    await loadStudentProfile();
                    loadClassData(); // Timetable & Tests
                    loadAnnouncements();
                    loadPaymentInfo();
                } else {
                    window.location.href = 'login.html';
                }
            });
        });

        // --- LOAD PROFILE ---
        async function loadStudentProfile() {
            try {
                const doc = await getCollection('students').doc(currentUser.uid).get();
                if (doc.exists) {
                    studentProfile = doc.data();
                    
                    // UI Updates
                    document.getElementById('sidebar-name').textContent = studentProfile.name;
                    document.getElementById('sidebar-initials').textContent = studentProfile.name.charAt(0).toUpperCase();
                    document.getElementById('sidebar-roll').textContent = studentProfile.rollNo;
                    document.getElementById('header-class-info').textContent = `${studentProfile.class} - ${studentProfile.section}`;
                    
                    document.getElementById('dash-due').textContent = "PKR " + (studentProfile.feeDue || 0).toLocaleString();
                    document.getElementById('fee-section-due').textContent = "PKR " + (studentProfile.feeDue || 0).toLocaleString();
                    
                    // Mock Attendance logic (Replace with real collection query if needed)
                    document.getElementById('dash-attendance').textContent = (studentProfile.attendance || 0) + "%";

                    // Load Transactions History
                    const tbody = document.getElementById('transactions-body');
                    tbody.innerHTML = '';
                    if (studentProfile.transactions && studentProfile.transactions.length > 0) {
                        // Sort descending date
                        const sortedTxs = studentProfile.transactions.sort((a,b) => new Date(b.date) - new Date(a.date));
                        sortedTxs.forEach(t => {
                            tbody.innerHTML += `
                                <tr class="border-b border-gray-50 hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap text-xs text-gray-500">${new Date(t.date).toLocaleDateString()}</td>
                                    <td class="px-6 py-4 text-sm text-gray-800">${t.description}</td>
                                    <td class="px-6 py-4 text-xs font-mono text-gray-500">${t.ref || '-'}</td>
                                    <td class="px-6 py-4 text-right font-bold text-green-600">+${parseInt(t.amount).toLocaleString()}</td>
                                </tr>
                            `;
                        });
                    } else {
                        tbody.innerHTML = '<tr><td colspan="4" class="p-6 text-center text-gray-400">No payment history found.</td></tr>';
                    }
                } else {
                    alert("Profile not found. Please contact Admin.");
                }
            } catch (error) {
                console.error("Profile Error", error);
            } finally {
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        }

        // --- LOAD CLASS DATA (Timetable & Tests) ---
        async function loadClassData() {
            if(!studentProfile) return;

            try {
                // 1. Find the Class Document ID based on Name & Section
                const classSnap = await getCollection('classes')
                    .where('name', '==', studentProfile.class)
                    .where('section', '==', studentProfile.section)
                    .limit(1)
                    .get();

                if (classSnap.empty) {
                    console.warn("Class configuration not found for this student.");
                    document.getElementById('timetable-body').innerHTML = '<tr><td colspan="4" class="p-6 text-center text-red-400">Class schedule not published yet.</td></tr>';
                    return;
                }

                classId = classSnap.docs[0].id;

                // 2. Load Timetable
                const ttSnap = await getCollection('classes').doc(classId).collection('timetable').get();
                const ttBody = document.getElementById('timetable-body');
                ttBody.innerHTML = '';
                
                if (ttSnap.empty) {
                    ttBody.innerHTML = '<tr><td colspan="4" class="p-6 text-center text-gray-400">No timetable available.</td></tr>';
                } else {
                    const daysOrder = { 'Monday':1, 'Tuesday':2, 'Wednesday':3, 'Thursday':4, 'Friday':5, 'Saturday':6 };
                    let slots = [];
                    ttSnap.forEach(d => slots.push(d.data()));
                    slots.sort((a,b) => (daysOrder[a.day] || 7) - (daysOrder[b.day] || 7) || a.start.localeCompare(b.start));

                    // Get Teacher Names (Optional optimization: Fetch all teachers once and map)
                    // For now, we assume admin saves teacher Name/ID. If only ID is saved, we need to fetch teacher doc.
                    // Assuming slot has teacherId. We will do a quick fetch or just display 'Teacher'.
                    // To make it fast, let's just display slot data. Ideally, fetch teacher name.
                    
                    for (const slot of slots) {
                        let teacherName = "Staff";
                        if(slot.teacherId) {
                            const tDoc = await getCollection('teachers').doc(slot.teacherId).get();
                            if(tDoc.exists) teacherName = tDoc.data().name;
                        }

                        ttBody.innerHTML += `
                            <tr class="hover:bg-blue-50 transition border-b border-gray-50">
                                <td class="px-6 py-4 font-bold text-blue-900">${slot.day}</td>
                                <td class="px-6 py-4 text-sm font-mono text-gray-600 bg-gray-50">${slot.start} - ${slot.end}</td>
                                <td class="px-6 py-4 font-medium text-gray-800">${slot.subject}</td>
                                <td class="px-6 py-4 text-sm text-gray-600"><i class="fas fa-chalkboard-teacher mr-2 text-blue-400"></i>${teacherName}</td>
                            </tr>
                        `;
                    }
                }

                // 3. Load Tests
                const testSnap = await getCollection('classes').doc(classId).collection('tests').get(); // Removed orderBy for safety
                const testContainer = document.getElementById('tests-container');
                testContainer.innerHTML = '';
                
                let upcomingTests = [];
                testSnap.forEach(d => upcomingTests.push(d.data()));
                // Sort in JS
                upcomingTests.sort((a,b) => new Date(a.date) - new Date(b.date));

                if(upcomingTests.length > 0) {
                    // Update Dashboard Widget
                    const next = upcomingTests[0];
                    document.getElementById('dash-next-test').textContent = next.subject;
                    document.getElementById('dash-next-test-date').textContent = new Date(next.date).toLocaleDateString() + ' @ ' + next.time;

                    // Render List
                    upcomingTests.forEach(t => {
                        testContainer.innerHTML += `
                            <div class="glass-card p-6 rounded-xl border-l-4 border-indigo-500 relative overflow-hidden group">
                                <div class="absolute top-0 right-0 bg-indigo-50 px-3 py-1 rounded-bl-lg text-xs font-bold text-indigo-700">
                                    ${t.time}
                                </div>
                                <h4 class="text-xl font-bold text-gray-800 mb-1">${t.subject}</h4>
                                <p class="text-sm text-gray-600 mb-4">${t.topic}</p>
                                <div class="flex items-center text-gray-500 text-sm">
                                    <i class="far fa-calendar-alt mr-2"></i>
                                    <span>${new Date(t.date).toLocaleDateString('en-US', {weekday:'long', month:'long', day:'numeric'})}</span>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    document.getElementById('dash-next-test').textContent = "No Tests";
                    document.getElementById('dash-next-test-date').textContent = "Relax!";
                    testContainer.innerHTML = '<div class="col-span-2 text-center py-10 text-gray-400 bg-white rounded-xl border border-dashed border-gray-300">No upcoming tests scheduled.</div>';
                }

            } catch (error) {
                console.error("Class Data Error", error);
            }
        }

        // --- ANNOUNCEMENTS ---
        async function loadAnnouncements() {
            const container = document.getElementById('announcements-container');
            const dashContainer = document.getElementById('dash-announcements');
            
            try {
                const snap = await getCollection('announcements')
                    .where('audience', 'in', ['all', 'students']) // Assuming 'students' audience might be added later
                    .get(); // Removing orderBy for index safety initially
                
                let items = [];
                snap.forEach(d => items.push(d.data()));
                items.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));

                container.innerHTML = '';
                dashContainer.innerHTML = '';

                if (items.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-400 py-8">No announcements.</div>';
                    dashContainer.innerHTML = '<div class="p-6 text-center text-gray-400">No new updates.</div>';
                    return;
                }

                items.forEach((a, index) => {
                    // Main List
                    container.innerHTML += `
                        <div class="glass-card p-5 rounded-xl border-l-4 border-yellow-400">
                            <h4 class="font-bold text-gray-800 text-lg mb-1">${a.title}</h4>
                            <p class="text-gray-600 text-sm leading-relaxed">${a.message}</p>
                            <p class="text-xs text-gray-400 mt-3 text-right">${new Date(a.createdAt).toLocaleString()}</p>
                        </div>
                    `;

                    // Dashboard Preview (Top 2)
                    if(index < 2) {
                        dashContainer.innerHTML += `
                            <div class="p-4 hover:bg-gray-50 transition">
                                <p class="font-bold text-sm text-gray-800">${a.title}</p>
                                <p class="text-xs text-gray-500 mt-1 line-clamp-1">${a.message}</p>
                            </div>
                        `;
                    }
                });

            } catch (error) {
                console.error("Announcements Error", error);
            }
        }

        // --- PAYMENTS ---
        async function loadPaymentInfo() {
            const list = document.getElementById('pending-payments-list');
            try {
                const snap = await getCollection('pending_payments')
                    .where('studentId', '==', currentUser.uid)
                    .get(); // removed orderby for safety
                
                let pendings = [];
                snap.forEach(d => pendings.push(d.data()));
                pendings.sort((a,b) => new Date(b.date) - new Date(a.date));

                list.innerHTML = '';
                if(pendings.length === 0) {
                    list.innerHTML = '<p class="text-sm text-gray-400 text-center py-2">No pending approvals.</p>';
                    return;
                }

                pendings.forEach(p => {
                    let statusColor = p.status === 'approved' ? 'text-green-600 bg-green-50' : (p.status === 'rejected' ? 'text-red-600 bg-red-50' : 'text-yellow-600 bg-yellow-50');
                    list.innerHTML += `
                        <div class="flex items-center justify-between p-3 border rounded-lg bg-gray-50">
                            <div>
                                <p class="text-sm font-bold text-gray-700">PKR ${p.amount}</p>
                                <p class="text-xs text-gray-500">${new Date(p.date).toLocaleDateString()}</p>
                            </div>
                            <span class="text-xs font-bold px-2 py-1 rounded ${statusColor} capitalize">${p.status}</span>
                        </div>
                    `;
                });
            } catch(e) { console.error(e); }
        }

        document.getElementById('form-proof').addEventListener('submit', (e) => {
            e.preventDefault();
            const amount = document.getElementById('proof-amount').value;
            const ref = document.getElementById('proof-ref').value;
            const file = document.getElementById('proof-file').files[0];

            if(file.size > 500 * 1024) { alert("File too large. Max 500KB."); return; }

            const reader = new FileReader();
            reader.onload = async function(evt) {
                const base64 = evt.target.result;
                const btn = e.target.querySelector('button');
                btn.textContent = "Uploading..."; btn.disabled = true;

                try {
                    await getCollection('pending_payments').add({
                        studentId: currentUser.uid,
                        amount: parseInt(amount),
                        ref: ref,
                        image: base64,
                        status: 'pending',
                        date: new Date().toISOString()
                    });
                    alert("Proof Submitted Successfully!");
                    closeModal('modal-pay');
                    e.target.reset();
                    loadPaymentInfo();
                } catch(err) {
                    alert("Error: " + err.message);
                } finally {
                    btn.textContent = "Submit for Approval";
                    btn.disabled = false;
                }
            };
            reader.readAsDataURL(file);
        });

        // --- NAVIGATION ---
        window.showSection = function(id) {
            document.querySelectorAll('.content-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => {
                b.classList.remove('active', 'bg-blue-800', 'text-white');
                b.classList.add('text-blue-100', 'hover:bg-blue-800');
            });
            const btn = document.getElementById('nav-' + id);
            if(btn) {
                btn.classList.add('active', 'bg-blue-800', 'text-white');
                btn.classList.remove('text-blue-100', 'hover:bg-blue-800');
            }
            document.getElementById('page-title').textContent = id.charAt(0).toUpperCase() + id.slice(1);
        }

        window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.logout = () => { localStorage.removeItem('grace_user_session'); window.location.href='login.html'; };
    </script>
</body>
</html>
