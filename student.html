<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Grace Academy - Student Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .sidebar { transition: transform 0.3s ease-in-out; }
        .sidebar.hidden-mobile { transform: translateX(-100%); }
        @media (min-width: 1024px) { .sidebar.hidden-mobile { transform: translateX(0); } }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .loader { border: 8px solid #f3f3f3; border-top: 8px solid #10B981; border-radius: 50%; width: 60px; height: 60px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .active-link { background-color: #047857; color: white; }
        
        /* Custom Modal Styles */
        .modal-backdrop { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .modal-backdrop.visible { opacity: 1; visibility: visible; }
        .modal-content { background: white; padding: 2rem; border-radius: 0.5rem; max-width: 500px; width: 90%; transform: scale(0.95); transition: transform 0.3s; }
        .modal-backdrop.visible .modal-content { transform: scale(1); }
    </style>
</head>
<body class="font-sans antialiased text-gray-800 bg-gray-50 flex min-h-screen">

    <div id="loading-overlay">
        <div class="loader"></div>
        <p id="loading-text" class="mt-4 text-lg text-gray-700">Loading Student Portal...</p>
    </div>

    <aside id="sidebar" class="sidebar bg-gradient-to-br from-green-700 to-green-900 text-white w-64 p-6 space-y-6 flex flex-col hidden-mobile fixed inset-y-0 left-0 lg:relative lg:translate-x-0 z-40 shadow-lg"></aside>

    <div class="flex-1 flex flex-col">
        <header class="bg-white shadow-md p-4 flex justify-between items-center lg:hidden sticky top-0 z-30">
            <button id="sidebar-toggle" class="text-green-700 focus:outline-none">
                <svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
            </button>
            <h1 class="text-2xl font-bold text-green-900">Student Panel</h1>
            <div class="flex items-center space-x-3">
                <span class="font-medium text-gray-700 hidden sm:block" id="topbar-student-name"></span>
                <img id="topbar-student-img" src="https://placehold.co/40x40/10B981/FFFFFF?text=S" alt="Student Profile" class="h-10 w-10 rounded-full border-2 border-green-500">
            </div>
        </header>

        <main class="flex-1 p-6 lg:p-10 bg-gray-50"></main>
    </div>

    <!-- Modal for notifications -->
    <div id="notification-modal" class="modal-backdrop">
        <div class="modal-content text-center">
            <h3 id="modal-title" class="text-2xl font-bold mb-4">Notification</h3>
            <p id="modal-message" class="mb-6"></p>
            <button id="modal-close-btn" class="bg-green-600 text-white px-6 py-2 rounded-lg">Close</button>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, onSnapshot, query, where, orderBy, addDoc, serverTimestamp, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Using the consistent "non-ruled" project configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA65vwfeuvsxnVSmlTof1_khaPmNtiMMv0",
            authDomain: "non-ruled.firebaseapp.com",
            projectId: "non-ruled",
            storageBucket: "non-ruled.firebasestorage.app",
            messagingSenderId: "981177762303",
            appId: "1:981177762303:web:7db5c95c3b264444e267ca",
            measurementId: "G-E3TY5JLVT5"
        };

        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let studentDataCache = null;

        onAuthStateChanged(auth, async (user) => {
            if (user && !user.isAnonymous) {
                const userDocRef = doc(db, "users", user.uid);
                const userDoc = await getDoc(userDocRef);

                if (userDoc.exists() && userDoc.data().role === 'student') {
                    const studentProfileRef = doc(db, "students", user.uid);
                    onSnapshot(studentProfileRef, (studentSnap) => {
                        if (studentSnap.exists()) {
                            studentDataCache = { id: user.uid, ...studentSnap.data() };
                            // Populate UI only once
                            if (!document.getElementById('sidebar').innerHTML.trim()) {
                                populateUI();
                                initializeStudentPortal(studentDataCache);
                            } else {
                                // Refresh currently viewed section if data changes
                                updateCurrentSection();
                            }
                        } else {
                            handleAuthError("Error: Your student profile does not exist.");
                        }
                    });
                } else {
                    handleAuthError("Access Denied. This portal is for students only.");
                }
            } else {
                handleAuthError("Please log in to access the student portal.");
            }
        });
        
        function handleAuthError(message) {
             loadingText.textContent = message + ' Redirecting...';
             setTimeout(() => window.location.href = 'login.html', 2000);
        }

        function populateUI() {
            document.getElementById('sidebar').innerHTML = `
                <div class="flex items-center space-x-3 border-b border-green-600 pb-4">
                    <img src="https://placehold.co/50x50/FFFFFF/10B981?text=GA" alt="Academy Logo" class="h-12 w-auto">
                    <span class="text-2xl font-bold tracking-tight">Student Portal</span>
                </div>
                <nav class="flex-1 space-y-2">
                    <a href="#dashboard" class="flex items-center space-x-3 px-4 py-2 rounded-lg text-lg hover:bg-green-600 transition duration-200"><i class="fas fa-home w-6"></i><span>Dashboard</span></a>
                    <a href="#my-profile" class="flex items-center space-x-3 px-4 py-2 rounded-lg text-lg hover:bg-green-600 transition duration-200"><i class="fas fa-user-circle w-6"></i><span>My Profile</span></a>
                    <a href="#my-assignments" class="flex items-center space-x-3 px-4 py-2 rounded-lg text-lg hover:bg-green-600 transition duration-200"><i class="fas fa-book-open w-6"></i><span>Assignments</span></a>
                    <a href="#my-results" class="flex items-center space-x-3 px-4 py-2 rounded-lg text-lg hover:bg-green-600 transition duration-200"><i class="fas fa-poll w-6"></i><span>My Results</span></a>
                    <a href="#fee-status" class="flex items-center space-x-3 px-4 py-2 rounded-lg text-lg hover:bg-green-600 transition duration-200"><i class="fas fa-file-invoice-dollar w-6"></i><span>Fee Status</span></a>
                    <a href="#announcements" class="flex items-center space-x-3 px-4 py-2 rounded-lg text-lg hover:bg-green-600 transition duration-200"><i class="fas fa-bullhorn w-6"></i><span>Announcements</span></a>
                    <a href="#library" class="flex items-center space-x-3 px-4 py-2 rounded-lg text-lg hover:bg-green-600 transition duration-200"><i class="fas fa-book-reader w-6"></i><span>Library</span></a>
                    <a href="#events" class="flex items-center space-x-3 px-4 py-2 rounded-lg text-lg hover:bg-green-600 transition duration-200"><i class="fas fa-calendar-check w-6"></i><span>Events</span></a>
                </nav>
                <div class="border-t border-green-600 pt-4">
                    <a href="index.html" class="flex items-center space-x-3 px-4 py-2 rounded-lg text-lg hover:bg-green-600 transition duration-200"><i class="fas fa-globe w-6"></i><span>Main Website</span></a>
                    <button id="logout-button" class="w-full flex items-center space-x-3 px-4 py-2 rounded-lg text-lg bg-red-600 hover:bg-red-700 transition duration-200 mt-2"><i class="fas fa-sign-out-alt w-6"></i><span>Logout</span></button>
                </div>`;
            
            document.querySelector('main').innerHTML = `
                <section id="dashboard" class="hidden"></section>
                <section id="my-profile" class="hidden"></section>
                <section id="my-assignments" class="hidden"></section>
                <section id="my-results" class="hidden"></section>
                <section id="fee-status" class="hidden"></section>
                <section id="announcements" class="hidden"></section>
                <section id="library" class="hidden"></section>
                <section id="events" class="hidden"></section>`;
            
            document.querySelectorAll('.sidebar nav a').forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); showSection(link.getAttribute('href').substring(1)); }); });
            document.getElementById('logout-button').addEventListener('click', () => signOut(auth));
            document.getElementById('sidebar-toggle').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('hidden-mobile'));
        }
        
        let currentSectionId = 'dashboard';
        
        function updateCurrentSection() {
            showSection(currentSectionId, true); // force re-render
        }

        function showSection(targetId, forceRender = false) {
             if (targetId === currentSectionId && !forceRender) return;
             currentSectionId = targetId;

            document.querySelectorAll('main section').forEach(sec => sec.classList.add('hidden'));
            document.querySelectorAll('.sidebar nav a').forEach(link => link.classList.remove('active-link'));
            
            const targetSection = document.getElementById(targetId);
            if (targetSection) {
                 targetSection.classList.remove('hidden');
                 document.querySelector(`.sidebar nav a[href="#${targetId}"]`).classList.add('active-link');

                 switch(targetId) {
                     case 'dashboard': renderDashboard(); break;
                     case 'my-profile': renderProfile(); break;
                     case 'my-assignments': renderAssignments(); break;
                     case 'my-results': renderResults(); break;
                     case 'fee-status': renderFeeStatus(); break;
                     case 'announcements': renderAnnouncements(); break;
                     case 'library': renderLibrary(); break;
                     case 'events': renderEvents(); break;
                 }
            }
            if (window.innerWidth < 1024) document.getElementById('sidebar').classList.add('hidden-mobile');
        }

        function initializeStudentPortal(studentData) {
            document.getElementById('topbar-student-name').textContent = studentData.name.split(' ')[0];
            document.getElementById('topbar-student-img').src = studentData.profileImageUrl || `https://placehold.co/40x40/10B981/FFFFFF?text=${studentData.name.charAt(0)}`;
            
            showSection('dashboard', true); // Show dashboard on initial load
            loadingOverlay.style.display = 'none';
        }

        // --- SECTION RENDERERS ---

        function renderDashboard() {
            const section = document.getElementById('dashboard');
            section.innerHTML = `<div class="bg-white p-8 rounded-lg shadow-xl fade-in">
                <h2 class="text-4xl font-extrabold text-green-900 mb-4">Welcome, ${studentDataCache.name}!</h2>
                <p class="text-lg text-gray-600">This is your personal portal. You can view your assignments, check your fee status, and see important announcements from the academy.</p>
            </div>`;
        }

        function renderProfile() {
            const section = document.getElementById('my-profile');
            section.innerHTML = `<div class="bg-white p-8 rounded-lg shadow-xl fade-in">
                <h2 class="text-4xl font-extrabold text-green-900 mb-8 border-b-2 border-green-200 pb-4">My Profile</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-lg">
                    <div><p class="font-semibold text-gray-500">Full Name:</p><p>${studentDataCache.name}</p></div>
                    <div><p class="font-semibold text-gray-500">Email:</p><p>${studentDataCache.email}</p></div>
                    <div><p class="font-semibold text-gray-500">Roll Number:</p><p>${studentDataCache.rollNo}</p></div>
                    <div><p class="font-semibold text-gray-500">Class:</p><p>${studentDataCache.class} ${studentDataCache.section || ''}</p></div>
                </div>
            </div>`;
        }

        function renderAssignments() {
            const section = document.getElementById('my-assignments');
            section.innerHTML = `<div class="bg-white p-8 rounded-lg shadow-xl fade-in">
                <h2 class="text-4xl font-extrabold text-green-900 mb-8 border-b-2 border-green-200 pb-4">My Assignments</h2>
                <div id="assignment-list" class="space-y-6">Loading assignments...</div>
            </div>`;
            
            const listContainer = section.querySelector('#assignment-list');
            const studentClass = `${studentDataCache.class} ${studentDataCache.section || ''}`.trim();
            const q = query(collection(db, "assignments"), where("assignedTo", "==", studentClass), orderBy("dueDate", "desc"));
            
            onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    listContainer.innerHTML = `<p class="text-gray-500">No assignments found for your class.</p>`;
                    return;
                }
                
                listContainer.innerHTML = snapshot.docs.map(doc => {
                    const ass = { id: doc.id, ...doc.data() };
                    const isSubmitted = (ass.submissions || []).some(sub => sub.studentId === studentDataCache.id);
                    const grade = (ass.submissions || []).find(sub => sub.studentId === studentDataCache.id)?.grade;

                    return `<div class="bg-gray-100 p-4 rounded-lg">
                        <div class="flex flex-wrap justify-between items-start gap-4">
                            <div>
                                <h3 class="font-bold text-xl">${ass.title}</h3>
                                <p class="text-sm text-gray-600">By: ${ass.teacher} | Due: ${ass.dueDate}</p>
                                <p class="mt-2">${ass.description}</p>
                            </div>
                            <div class="flex-shrink-0">
                                ${isSubmitted 
                                    ? `<div class="text-center"><span class="px-3 py-1 rounded-full text-sm font-semibold bg-green-200 text-green-800">Submitted</span>
                                        ${grade ? `<p class="text-sm mt-2">Grade: <span class="font-bold">${grade}</span></p>` : `<p class="text-sm mt-2 text-gray-500">Not Graded Yet</p>`}
                                      </div>` 
                                    : `<button class="submit-assignment-btn bg-blue-600 text-white px-4 py-2 rounded-lg" data-id="${ass.id}">Submit</button>`
                                }
                            </div>
                        </div>
                    </div>`;
                }).join('');
                
                section.querySelectorAll('.submit-assignment-btn').forEach(btn => btn.addEventListener('click', (e) => showSubmissionModal(e.currentTarget.dataset.id)));
            }, (error) => listContainer.innerHTML = `<p class="text-red-500">Error loading assignments.</p>`);
        }

        function renderResults() {
            const section = document.getElementById('my-results');
            section.innerHTML = `<div class="bg-white p-8 rounded-lg shadow-xl fade-in">
                <h2 class="text-4xl font-extrabold text-green-900 mb-8 border-b-2 border-green-200 pb-4">My Results</h2>
                <div id="results-container" class="space-y-8">Loading results...</div>
            </div>`;
            
            const resultsContainer = section.querySelector('#results-container');
            const resultsQuery = query(collection(db, `students/${studentDataCache.id}/results`), orderBy("examDate", "desc"));

            onSnapshot(resultsQuery, (snapshot) => {
                if (snapshot.empty) {
                    resultsContainer.innerHTML = `<p class="text-gray-500">No results have been published for you yet.</p>`;
                    return;
                }

                // Group results by exam name
                const resultsByExam = snapshot.docs.reduce((acc, doc) => {
                    const result = doc.data();
                    const examName = result.examName || 'Uncategorized';
                    if (!acc[examName]) {
                        acc[examName] = {
                            results: [],
                            totalObtained: 0,
                            totalMarks: 0,
                            date: result.examDate ? result.examDate.toDate().toLocaleDateString() : 'N/A'
                        };
                    }
                    acc[examName].results.push(result);
                    acc[examName].totalObtained += Number(result.obtainedMarks) || 0;
                    acc[examName].totalMarks += Number(result.totalMarks) || 0;
                    return acc;
                }, {});

                resultsContainer.innerHTML = Object.entries(resultsByExam).map(([examName, data]) => {
                    const overallPercentage = data.totalMarks > 0 ? ((data.totalObtained / data.totalMarks) * 100).toFixed(2) : 0;
                    let percentageColor = 'text-gray-800';
                    if (overallPercentage >= 80) percentageColor = 'text-green-600';
                    else if (overallPercentage >= 60) percentageColor = 'text-blue-600';
                    else if (overallPercentage >= 40) percentageColor = 'text-yellow-600';
                    else percentageColor = 'text-red-600';

                    return `
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-6 shadow-md">
                            <div class="flex flex-wrap justify-between items-center mb-4 border-b pb-3">
                                <div>
                                    <h3 class="text-2xl font-bold text-gray-800">${examName}</h3>
                                    <p class="text-sm text-gray-500">Date: ${data.date}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-lg font-semibold">Overall: <span class="font-bold ${percentageColor}">${overallPercentage}%</span></p>
                                    <p class="text-sm text-gray-600">Total: ${data.totalObtained} / ${data.totalMarks}</p>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full">
                                    <thead class="text-left text-sm text-gray-500">
                                        <tr>
                                            <th class="py-2 px-3 font-medium">Subject</th>
                                            <th class="py-2 px-3 font-medium text-center">Obtained Marks</th>
                                            <th class="py-2 px-3 font-medium text-center">Total Marks</th>
                                            <th class="py-2 px-3 font-medium text-center">Percentage</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${data.results.map(r => {
                                            const subjectPercentage = r.totalMarks > 0 ? ((r.obtainedMarks / r.totalMarks) * 100).toFixed(2) : 0;
                                            return `
                                            <tr class="border-t">
                                                <td class="py-3 px-3 font-semibold">${r.subject}</td>
                                                <td class="py-3 px-3 text-center">${r.obtainedMarks}</td>
                                                <td class="py-3 px-3 text-center">${r.totalMarks}</td>
                                                <td class="py-3 px-3 text-center font-medium">${subjectPercentage}%</td>
                                            </tr>
                                            `
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }).join('');

            }, (error) => {
                console.error("Error fetching results: ", error);
                resultsContainer.innerHTML = `<p class="text-red-500">Could not load results. Please try again later.</p>`;
            });
        }


        function renderFeeStatus() {
            const section = document.getElementById('fee-status');
            const isPaid = studentDataCache.feeStatus === 'Paid';
            const statusClass = isPaid ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800';

            section.innerHTML = `<div class="bg-white p-8 rounded-lg shadow-xl fade-in">
                <h2 class="text-4xl font-extrabold text-green-900 mb-8 border-b-2 border-green-200 pb-4">Fee Status</h2>
                <div class="mb-8 text-center bg-gray-50 p-6 rounded-lg">
                    <p class="text-lg text-gray-600 mb-2">Current Month's Fee Status</p>
                    <p class="text-3xl font-bold"><span class="px-4 py-2 rounded-full ${statusClass}">${studentDataCache.feeStatus || 'Unpaid'}</span></p>
                </div>
                
                <div id="payment-section"></div>
                <div id="payment-history-section">
                    <h3 class="text-2xl font-bold text-gray-700 mb-4">Payment History</h3>
                    <div id="payment-history-list" class="space-y-2">Loading history...</div>
                </div>
            </div>`;
            
            if (!isPaid) {
                renderPaymentForm();
            }

            renderPaymentHistory();
        }
        
        async function renderPaymentForm() {
            const paymentSection = document.getElementById('payment-section');
            const settingsSnap = await getDoc(doc(db, 'settings', 'payment'));
            const settings = settingsSnap.exists() ? settingsSnap.data() : {};

            paymentSection.innerHTML = `<div class="mb-8 border rounded-lg p-6">
                    <h3 class="text-2xl font-bold text-gray-700 mb-4">Submit Payment Proof</h3>
                    <div class="mb-6 space-y-4">
                        <p class="font-semibold">Please transfer your fee to one of the accounts below:</p>
                        ${settings.easypaisaNumber ? `<div><p><b>Easypaisa:</b> ${settings.easypaisaTitle} - ${settings.easypaisaNumber}</p></div>` : ''}
                        ${settings.bankIban ? `<div><p><b>Bank Transfer:</b> ${settings.bankName}, ${settings.bankTitle} - ${settings.bankIban}</p></div>` : ''}
                    </div>
                    <form id="payment-proof-form">
                        <label for="proof-url" class="block font-medium mb-2">Proof of Payment URL (e.g., Imgur link)</label>
                        <input type="url" id="proof-url" class="w-full p-2 border rounded" placeholder="https://i.imgur.com/your-receipt.jpg" required>
                        <button type="submit" class="bg-green-600 text-white px-5 py-2 rounded-lg font-medium mt-4">Submit for Verification</button>
                    </form>
                </div>`;
            
            document.getElementById('payment-proof-form').addEventListener('submit', handlePaymentProofSubmit);
        }

        async function renderPaymentHistory() {
            const historyList = document.getElementById('payment-history-list');
            const q = query(collection(db, `students/${studentDataCache.id}/paymentHistory`), orderBy("date", "desc"));
            onSnapshot(q, (snapshot) => {
                if(snapshot.empty) { historyList.innerHTML = `<p class="text-gray-500">No payment history found.</p>`; return; }
                historyList.innerHTML = snapshot.docs.map(doc => {
                    const record = doc.data();
                    const date = record.date ? record.date.toDate().toLocaleDateString() : 'N/A';
                    return `<div class="bg-gray-100 p-3 rounded-md flex justify-between">
                                <span>${date} - ${record.method}</span>
                                <span class="font-semibold text-green-700">${record.status}</span>
                            </div>`;
                }).join('');
            });
        }

        function renderAnnouncements() {
            const section = document.getElementById('announcements');
            section.innerHTML = `<div class="bg-white p-8 rounded-lg shadow-xl fade-in">
                <h2 class="text-4xl font-extrabold text-green-900 mb-8 border-b-2 border-green-200 pb-4">Announcements</h2>
                <div id="announcement-list" class="space-y-4">Loading announcements...</div>
            </div>`;

            const list = section.querySelector('#announcement-list');
            onSnapshot(query(collection(db, "announcements"), orderBy("date", "desc")), (snapshot) => {
                if(snapshot.empty) { list.innerHTML = `<p class="text-gray-500">No announcements found.</p>`; return; }
                list.innerHTML = snapshot.docs.map(doc => {
                    const ann = doc.data();
                    return `<div class="bg-gray-100 p-4 rounded-lg"><h3 class="font-bold text-lg">${ann.title}</h3><p>${ann.content}</p><p class="text-sm text-gray-500 mt-2">Date: ${ann.date}</p></div>`;
                }).join('');
            });
        }
        
        function renderLibrary() {
            const section = document.getElementById('library');
            section.innerHTML = `<div class="bg-white p-8 rounded-lg shadow-xl fade-in">
                <h2 class="text-4xl font-extrabold text-green-900 mb-8 border-b-2 border-green-200 pb-4">Digital Library</h2>
                <div id="library-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">Loading books...</div>
            </div>`;
            
            const listContainer = section.querySelector('#library-list');
            const q = query(collection(db, "libraryBooks"), orderBy("title"));
            
            onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    listContainer.innerHTML = `<p class="text-gray-500 col-span-full">No books are available in the library at the moment.</p>`;
                    return;
                }
                
                listContainer.innerHTML = snapshot.docs.map(doc => {
                    const book = { id: doc.id, ...doc.data() };
                    return `<div class="bg-gray-50 border rounded-lg p-4 flex flex-col items-center text-center">
                                <img src="${book.coverUrl || 'https://placehold.co/150x200'}" alt="${book.title}" class="w-32 h-44 object-cover rounded shadow-md mb-4">
                                <h3 class="font-bold text-lg">${book.title}</h3>
                                <p class="text-sm text-gray-600 mb-2">by ${book.author}</p>
                                <p class="text-xs text-gray-500 mb-4">${book.category}</p>
                                <a href="${book.fileUrl}" target="_blank" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-green-700 transition-colors">Read Book</a>
                            </div>`;
                }).join('');
            });
        }

        function renderEvents() {
            const section = document.getElementById('events');
            section.innerHTML = `<div class="bg-white p-8 rounded-lg shadow-xl fade-in">
                <h2 class="text-4xl font-extrabold text-green-900 mb-8 border-b-2 border-green-200 pb-4">Upcoming Events</h2>
                <div id="event-list" class="space-y-6">Loading events...</div>
            </div>`;

            const listContainer = section.querySelector('#event-list');
            const q = query(collection(db, "events"), orderBy("date"));

            onSnapshot(q, (snapshot) => {
                if(snapshot.empty) {
                    listContainer.innerHTML = `<p class="text-gray-500">There are no upcoming events scheduled.</p>`;
                    return;
                }
                listContainer.innerHTML = snapshot.docs.map(doc => {
                    const event = { id: doc.id, ...doc.data() };
                    return `<div class="bg-gray-100 p-4 rounded-lg flex items-start space-x-4">
                                <div class="flex-shrink-0 bg-green-600 text-white rounded-lg p-3 text-center w-20">
                                    <p class="text-3xl font-bold">${new Date(event.date).getDate()}</p>
                                    <p class="text-sm">${new Date(event.date).toLocaleString('default', { month: 'short' })}</p>
                                </div>
                                <div>
                                    <h3 class="font-bold text-xl">${event.title}</h3>
                                    <p class="text-sm text-gray-600">${event.time} at ${event.location}</p>
                                    <p class="mt-1">${event.description}</p>
                                </div>
                            </div>`;
                }).join('');
            });
        }
        
        // --- MODAL & FORM LOGIC ---

        function showSubmissionModal(assignmentId) {
            const modal = document.getElementById('notification-modal');
            const title = modal.querySelector('#modal-title');
            const message = modal.querySelector('#modal-message');
            
            title.textContent = "Submit Assignment";
            message.innerHTML = `
                <form id="submission-form" class="text-left">
                    <label for="submission-url" class="block font-medium mb-2">Submission URL (e.g., Google Drive, Imgur)</label>
                    <input type="url" id="submission-url" class="w-full p-2 border rounded" placeholder="https://docs.google.com/..." required>
                    <p class="text-xs text-gray-500 mt-1">Please ensure the link is publicly accessible.</p>
                </form>
            `;
            modal.querySelector('#modal-close-btn').textContent = "Submit";
            
            const closeBtn = modal.querySelector('#modal-close-btn');
            const newSubmitBtn = closeBtn.cloneNode(true); // Avoid multiple listeners
            closeBtn.parentNode.replaceChild(newSubmitBtn, closeBtn);

            newSubmitBtn.onclick = () => handleAssignmentSubmit(assignmentId);
            modal.classList.add('visible');
            
            // Add a temporary close button
             const tempClose = document.createElement('button');
             tempClose.textContent = 'Cancel';
             tempClose.className = 'bg-gray-300 text-gray-800 px-6 py-2 rounded-lg ml-2';
             tempClose.onclick = () => modal.classList.remove('visible');
             newSubmitBtn.insertAdjacentElement('afterend', tempClose);
        }
        
        async function handleAssignmentSubmit(assignmentId) {
            const submissionUrl = document.getElementById('submission-url').value;
            if (!submissionUrl) {
                showNotification("Error", "Submission URL cannot be empty.");
                return;
            }
            
            const assignmentRef = doc(db, 'assignments', assignmentId);
            const submissionData = {
                studentId: studentDataCache.id,
                studentName: studentDataCache.name, // for easier lookup by teacher
                fileUrl: submissionUrl,
                submittedAt: serverTimestamp(),
                grade: null
            };
            
            // This is a simple implementation. A better approach uses arrayUnion in a transaction.
            const assignmentDoc = await getDoc(assignmentRef);
            const submissions = assignmentDoc.data().submissions || [];
            submissions.push(submissionData);
            
            await updateDoc(assignmentRef, { submissions: submissions });
            
            showNotification("Success", "Your assignment has been submitted successfully!");
        }

        async function handlePaymentProofSubmit(e) {
            e.preventDefault();
            const proofUrl = document.getElementById('proof-url').value;
            const data = {
                studentId: studentDataCache.id,
                studentName: studentDataCache.name,
                studentClass: `${studentDataCache.class} ${studentDataCache.section || ''}`.trim(),
                proofUrl: proofUrl,
                submittedAt: serverTimestamp(),
                status: 'Pending'
            };
            
            await addDoc(collection(db, "paymentRequests"), data);
            showNotification("Success", "Your payment proof has been submitted for verification.");
            document.getElementById('payment-section').innerHTML = `<p class="text-center font-semibold text-blue-700">Your payment request is pending review.</p>`;
        }
        
        function showNotification(title, message) {
            const modal = document.getElementById('notification-modal');
            modal.querySelector('#modal-title').textContent = title;
            modal.querySelector('#modal-message').innerHTML = `<p>${message}</p>`; // Use innerHTML to allow simple formatting if needed
            
            const closeBtn = modal.querySelector('#modal-close-btn');
            closeBtn.textContent = 'Close';
            
            // Re-clone to remove old event listeners
            const newCloseBtn = closeBtn.cloneNode(true);
            closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);

            newCloseBtn.onclick = () => modal.classList.remove('visible');
            modal.classList.add('visible');
        }
        
        document.getElementById('modal-close-btn').addEventListener('click', () => {
             document.getElementById('notification-modal').classList.remove('visible');
        });

    </script>
</body>
</html>
