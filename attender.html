<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Grace Academy - Attender Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .sidebar { transition: transform 0.3s ease-in-out; }
        .sidebar.hidden-mobile { transform: translateX(-100%); }
        @media (min-width: 1024px) { .sidebar.hidden-mobile { transform: translateX(0); } }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .loader { border: 8px solid #f3f3f3; border-top: 8px solid #D97706; border-radius: 50%; width: 60px; height: 60px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .active-link { background-color: #B45309; color: white; }
    </style>
</head>
<body class="font-sans antialiased text-gray-800 bg-gray-50 flex min-h-screen">

    <div id="loading-overlay">
        <div class="loader"></div>
        <p id="loading-text" class="mt-4 text-lg text-gray-700">Loading Attender Portal...</p>
    </div>

    <aside id="sidebar" class="sidebar bg-gradient-to-br from-yellow-600 to-yellow-800 text-white w-64 p-6 space-y-6 flex flex-col hidden-mobile fixed inset-y-0 left-0 lg:relative lg:translate-x-0 z-40 shadow-lg">
        <div class="flex items-center space-x-3 border-b border-yellow-500 pb-4">
            <img src="download (2).png" alt="Academy Logo" class="h-12 w-auto bg-white rounded-full">
            <span class="text-2xl font-bold tracking-tight">Attender</span>
        </div>
        <nav class="flex-1 space-y-2">
            <a href="#" class="flex items-center space-x-3 px-4 py-2 rounded-lg text-lg bg-yellow-700 text-white active-link">
                <i class="fas fa-clipboard-check w-6"></i><span>Mark Attendance</span>
            </a>
        </nav>
        <div class="border-t border-yellow-500 pt-4">
            <button id="logout-button" class="w-full flex items-center space-x-3 px-4 py-2 rounded-lg text-lg bg-red-600 hover:bg-red-700 transition duration-200 mt-2">
                <i class="fas fa-sign-out-alt w-6"></i><span>Logout</span>
            </button>
        </div>
    </aside>

    <div class="flex-1 flex flex-col">
        <header class="bg-white shadow-md p-4 flex justify-between items-center lg:hidden sticky top-0 z-30">
            <button id="sidebar-toggle" class="text-yellow-800 focus:outline-none">
                <svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
            </button>
            <h1 class="text-2xl font-bold text-yellow-900">Attendance Panel</h1>
            <div class="flex items-center space-x-3">
                <span class="font-medium text-gray-700 hidden sm:block" id="topbar-name">Attender</span>
                <img id="topbar-img" src="https://placehold.co/40x40/D97706/FFFFFF?text=A" class="h-10 w-10 rounded-full border-2 border-yellow-500">
            </div>
        </header>

        <main class="flex-1 p-6 lg:p-10 bg-gray-50">
            <div class="bg-white p-8 rounded-lg shadow-xl">
                <h2 class="text-4xl font-extrabold text-yellow-900 mb-8 border-b-2 border-yellow-200 pb-4">Mark Student Attendance</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div>
                        <label class="block font-medium mb-2">Date</label>
                        <input type="date" id="attendance-date" class="w-full p-3 border rounded-lg shadow-sm focus:ring-yellow-500 focus:border-yellow-500">
                    </div>
                    <div>
                        <label class="block font-medium mb-2">Class</label>
                        <select id="class-select" class="w-full p-3 border rounded-lg shadow-sm focus:ring-yellow-500 focus:border-yellow-500">
                            <option value="">Select Class</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button id="load-students-btn" class="w-full bg-yellow-600 text-white p-3 rounded-lg font-bold hover:bg-yellow-700 transition shadow-md">
                            Load Students
                        </button>
                    </div>
                </div>

                <div id="attendance-sheet" class="hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-700">Student List</h3>
                        <div class="space-x-2">
                             <button onclick="markAll('Present')" class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded hover:bg-green-200">All Present</button>
                             <button onclick="markAll('Absent')" class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded hover:bg-red-200">All Absent</button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto border rounded-lg shadow-sm">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="py-3 px-4 text-left font-semibold text-gray-600">Roll No</th>
                                    <th class="py-3 px-4 text-left font-semibold text-gray-600">Name</th>
                                    <th class="py-3 px-4 text-center font-semibold text-gray-600">Status</th>
                                </tr>
                            </thead>
                            <tbody id="student-list-body" class="divide-y divide-gray-200"></tbody>
                        </table>
                    </div>

                    <div class="mt-8 text-right">
                        <button id="save-attendance-btn" class="bg-green-600 text-white px-8 py-3 rounded-lg font-bold hover:bg-green-700 transition shadow-lg transform hover:scale-105">
                            Save Attendance
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, orderBy, getDocs, setDoc, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA65vwfeuvsxnVSmlTof1_khaPmNtiMMv0",
            authDomain: "non-ruled.firebaseapp.com",
            projectId: "non-ruled",
            storageBucket: "non-ruled.firebasestorage.app",
            messagingSenderId: "981177762303",
            appId: "1:981177762303:web:7db5c95c3b264444e267ca",
            measurementId: "G-E3TY5JLVT5"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        
        // Initialize Date Input with Today
        document.getElementById('attendance-date').valueAsDate = new Date();

        onAuthStateChanged(auth, async (user) => {
            if (user && !user.isAnonymous) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists() && userDoc.data().role === 'attender') {
                    const attenderDoc = await getDoc(doc(db, "attenders", user.uid));
                    if(attenderDoc.exists()) {
                        const data = attenderDoc.data();
                        document.getElementById('topbar-name').textContent = data.name;
                    }
                    loadClasses();
                    loadingOverlay.style.display = 'none';
                } else {
                    window.location.href = 'login.html';
                }
            } else {
                window.location.href = 'login.html';
            }
        });

        async function loadClasses() {
            const q = query(collection(db, 'classes'), orderBy('name'));
            const snapshot = await getDocs(q);
            const select = document.getElementById('class-select');
            snapshot.forEach(doc => {
                const opt = document.createElement('option');
                opt.value = doc.id;
                opt.textContent = doc.data().name;
                select.appendChild(opt);
            });
        }

        document.getElementById('load-students-btn').addEventListener('click', async () => {
            const classId = document.getElementById('class-select').value;
            const date = document.getElementById('attendance-date').value;

            if (!classId || !date) { alert('Please select a class and date.'); return; }

            const listBody = document.getElementById('student-list-body');
            listBody.innerHTML = '<tr><td colspan="3" class="text-center p-4">Loading...</td></tr>';
            document.getElementById('attendance-sheet').classList.remove('hidden');

            // Fetch students
            const studentsQ = query(collection(db, 'students'), where('classId', '==', classId), orderBy('rollNo'));
            const studentsSnap = await getDocs(studentsQ);
            
            // Check if attendance already exists
            const attendanceDocRef = doc(db, 'classAttendance', `${classId}_${date}`);
            const attendanceSnap = await getDoc(attendanceDocRef);
            const existingRecords = attendanceSnap.exists() ? attendanceSnap.data().records : {};

            listBody.innerHTML = '';
            if (studentsSnap.empty) {
                listBody.innerHTML = '<tr><td colspan="3" class="text-center p-4 text-red-500">No students found in this class.</td></tr>';
                return;
            }

            studentsSnap.forEach(doc => {
                const s = doc.data();
                const status = existingRecords[doc.id] || 'Present'; // Default to Present
                
                const row = document.createElement('tr');
                row.className = "hover:bg-gray-50";
                row.innerHTML = `
                    <td class="py-3 px-4">${s.rollNo}</td>
                    <td class="py-3 px-4 font-medium">${s.name}</td>
                    <td class="py-3 px-4 text-center">
                        <div class="inline-flex rounded-md shadow-sm" role="group">
                            <label class="cursor-pointer">
                                <input type="radio" name="status-${doc.id}" value="Present" class="peer sr-only" ${status === 'Present' ? 'checked' : ''}>
                                <span class="px-3 py-1 bg-white border border-gray-300 rounded-l-lg text-sm peer-checked:bg-green-600 peer-checked:text-white peer-checked:border-green-600 hover:bg-gray-100">P</span>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="status-${doc.id}" value="Absent" class="peer sr-only" ${status === 'Absent' ? 'checked' : ''}>
                                <span class="px-3 py-1 bg-white border-t border-b border-gray-300 text-sm peer-checked:bg-red-600 peer-checked:text-white peer-checked:border-red-600 hover:bg-gray-100">A</span>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="status-${doc.id}" value="Late" class="peer sr-only" ${status === 'Late' ? 'checked' : ''}>
                                <span class="px-3 py-1 bg-white border border-gray-300 rounded-r-lg text-sm peer-checked:bg-yellow-500 peer-checked:text-white peer-checked:border-yellow-500 hover:bg-gray-100">L</span>
                            </label>
                        </div>
                    </td>
                `;
                listBody.appendChild(row);
            });
        });

        window.markAll = (status) => {
            const radios = document.querySelectorAll(`input[type="radio"][value="${status}"]`);
            radios.forEach(r => r.checked = true);
        };

        document.getElementById('save-attendance-btn').addEventListener('click', async () => {
            const classId = document.getElementById('class-select').value;
            const date = document.getElementById('attendance-date').value;
            const btn = document.getElementById('save-attendance-btn');

            if (!classId || !date) return;

            btn.disabled = true;
            btn.textContent = "Saving...";

            const records = {};
            // Gather all radio inputs
            const rows = document.getElementById('student-list-body').querySelectorAll('tr');
            rows.forEach(row => {
                const radio = row.querySelector('input[type="radio"]:checked');
                if (radio) {
                    const studentId = radio.name.replace('status-', '');
                    records[studentId] = radio.value;
                }
            });

            try {
                await setDoc(doc(db, 'classAttendance', `${classId}_${date}`), {
                    classId: classId,
                    date: date,
                    records: records,
                    updatedAt: new Date()
                });
                alert('Attendance saved successfully!');
            } catch (e) {
                console.error(e);
                alert('Error saving attendance.');
            } finally {
                btn.disabled = false;
                btn.textContent = "Save Attendance";
            }
        });

        document.getElementById('logout-button').addEventListener('click', () => signOut(auth));
        document.getElementById('sidebar-toggle').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('hidden-mobile'));

    </script>
</body>
</html>
